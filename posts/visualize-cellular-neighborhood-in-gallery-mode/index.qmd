---
title: "Visualize cellular neighborhood in gallery mode"
author:
  - name: Lidan Wu
    orcid: 0000-0003-3150-6170
    affiliations: 
      - ref: nstg
      - ref: lidanwu
  - name: Patrick Danaher
    orcid: 0000-0002-2844-5883
    affiliations:
      - ref: nstg
      - ref: patrickjdanaher
date: "2024-01-24"
date-modified: "2024-04-17"
categories: [visualization, napari]
draft: false
image: figures/fig6.png
---

## Visualize cellular neighborhood in gallery mode

A complete CosMx dataset will contain cell metadata, morphology/protein images and cell label results of cell segmentation. 
We've created a toolkit for visualizing the neighborhood of query cells in terms of protein staining, cell segmentation border, numeric and categorical metadata. (Note: we are *not* performing cell typing or cell segmetnation here, just drawing boundaries from the existing cell label/segmetnation results.)

You can find the package [here](https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/tree/Main/_code/NeighVizGallery){target="_blank"}. See the corresponding [tutorial](https://github.com/Nanostring-Biostats/CosMx-Analysis-Scratch-Space/blob/Main/_code/NeighVizGallery/vignettes/tutorial.R){target="_blank"} inside the package for more details. 

The inputs required:

- cell metadata with unique cell_ID in format of `c_[slide]_[fov]_[CellId]`.

- Either file path to `CellStatsDir` that contains per FOV level of cell label images, morphology C902 images and optional `ProteinDir` that contains per FOV level of protein images. 

- Or file path to `napari-cosmx` dataset which contains stitched images for cell label, morphology and optional protein images of entire slide.


This code expects the file format output generated by CosMx Single Molecular Imager (SMI) and `napari-cosMx` plugin. Here are the example data/folder structure of the required input files. 

- Example cell metadata:

![](figures/fig1.png)
  

- Example `CellStatsDir` and `ProteinDir` under raw data folder of given slide. 

  1. Each FOV subfolder under `CellStatsDir` contains cell label images of given FOV. 
  
![](figures/fig2.png)

  
  2. `Morphology2D` subfolder under `CellStatsDir` contains multi-channel morphology images of each FOV.  
  
![](figures/fig3.png)
  
  
  3. Each FOV subfolder under `ProteinDir` contains a folder called `ProteinImages`, which has single-channel images for all the protein profiled for the given FOV. 
  
![](figures/fig4.png)


- Example `napari-cosmx` dataset with stitched images: `labels` for cell labels, `protein/[proteinName]` for single-channel protein images, other folders (e.g. `DNA`) for single-channel morphology images. 

![](figures/fig5.png)

Below are the example outputs of plotting query cells' neighborhood: 

  - Plotting morphology images and cell borers of query cells's neighborhood 
  
![](figures/fig6.png)

  - Plotting numeric and categorical metadata of query cells' neighborhood
  
![](figures/fig7.png)


